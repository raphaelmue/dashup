<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<template id="dashupInput">
    <style>
        .input-css {
            display: inline-block;
            -webkit-box-sizing: content-box;
            -moz-box-sizing: content-box;
            box-sizing: content-box;
            padding: 10px 20px;
            border: 1px solid #b7b7b7;
            -webkit-border-radius: 3px;
            border-radius: 3px;
            font: normal 16px/normal "Times New Roman", Times, serif;
            color: rgba(0,0,0,1);
            -o-text-overflow: clip;
            text-overflow: clip;
            -webkit-box-shadow: 2px 2px 2px 0 rgba(0,0,0,0.2) inset;
            box-shadow: 2px 2px 2px 0 rgba(0,0,0,0.2) inset;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.66) ;
            -webkit-transition: all 200ms cubic-bezier(0.42, 0, 0.58, 1);
            -moz-transition: all 200ms cubic-bezier(0.42, 0, 0.58, 1);
            -o-transition: all 200ms cubic-bezier(0.42, 0, 0.58, 1);
            transition: all 200ms cubic-bezier(0.42, 0, 0.58, 1);
        }
    </style>
    <input id="input" type="text" class="input-css" />
</template>

<script>
    const dashupInput = document.currentScript.ownerDocument.querySelector('#dashupInput').content;

    class InputComponent extends HTMLElement {

        constructor(){
            super();
            this.attachShadow({mode: 'open'});
            this.content = document.importNode(dashupInput, true);
            this.shadowRoot.appendChild(this.content);

            this.input = this.shadowRoot.querySelector('#input');
            this.text = this.input.value;
            if(this.hasAttribute('api') && this._validURL(this.api)){
                this._appendListener();
            }
        }

        _appendListener(){
            let url;
            this.input.addEventListener('onchange', () => {
                switch(this.action){
                    case 'rfc':
                        url = this._handleParams();
                        fetch(url).then(function(response) {
                            if(response.status = 200){
                                this.input.style.backgroundColor = "green";
                                setTimeout(() => {
                                    this.input.style.backgroundColor = "";
                                }, 1000);
                            } else {
                                this.input.style.backgroundColor = "red";
                                setTimeout(() => {
                                    this.input.style.backgroundColor = "";
                                }, 1000);
                            }
                        });
                        break;
                    case 'data':
                        url = this._handleParams();
                        fetch(url).then(function(response) {
                                return response.json();
                            })
                            .then(function(response) {
                                let display = this.getAttribute('consumers').split(" ");
                                display.forEach(val => {
                                    let obj = document.querySelector("[name='" + val + "']")
                                    obj.passData(response[val]);
                                })
                            });
                        break;
                }
            });
        }

        _handleParams(){
            if(this.hasAttribute('param')){
                let url = this.api.includes('?') ? this.api + "&" : this.api + "?";
                url += this.getAttribute('param') + "=" + this.text;
            } else {
                let url = this.api;
            }
            return url;
        }

        _validURL(str) {
            var regexp = /(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/
            return regexp.test(str);
        }

        static get observedAttributes() {
            return ['action', 'api', 'param', 'consumers'];
        }

        connectedCallback() {
            if (this.hasAttribute('api') && !this.hasAttribute('action')) {
                this.setAttribute('action', 'rpc');
            }
        }

        disconnectedCallback() {
            //NOOP
        }

        adoptedCallback(){
            //NOOP
        }

        attributeChangedCallback(name, oldValue, newValue) {
            this.input.onchange();
        }

        get name(){
            return this.getAttribute('name');
        }

        set name(val){
            this.setAttribute('name', val);
        }

        get formGroup(){
            return this.getAttribute('group');
        }

        set formGroup(val){
            this.setAttribute('group', val);
        }

        get action(){
            return this.getAttribute('action');
        }

        set action(val){
            this.setAttribute('action', val);
        }

        get api(){
            return this.getAttribute('api');
        }

        set api(val){
            this.setAttribute('api', val);
        }

        get param(){
            return this.getAttribute('param');
        }

        set param(val){
            this.setAttribute('param', val);
        }

        get consumers(){
            return this.getAttribute('consumers');
        }

        set consumers(val){
            this.setAttribute('consumers', val);
        }

    }

    customElements.define("dashup-input", InputComponent);
</script>